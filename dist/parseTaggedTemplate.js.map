{"version":3,"file":"parseTaggedTemplate.js","sources":["../src/parseTaggedTemplate.js"],"sourcesContent":["import htmlparser from 'htmlparser2';\nimport undeclared from 'undeclared';\nimport astring from 'astring';\n\nconst attrPattern = /\\s*?([a-zA-Z0-9\\-]+?)=$/;\nconst specials = {\n\ton: 'event',\n\tclass: 'class'\n};\n\nexport default function parse( { expressions, quasis } ){\n\n\tconst getEl = ( name = 'root' ) => ({\n\t\tname, \n\t\tattributes: {}, \n\t\tbindings: [],\n\t\tchildBindings: [],\n\t\tchildCurrentIndex: -1\n\t});\n\n\tconst fragment = getEl();\n\tconst html = [];\n\tconst stack = [];\n\tlet currentEl = fragment;\n\tlet inElTag = false;\n\tlet currentAttr = null;\n\n\tconst handler = {\n\t\tonopentagname( name ) {\n\t\t\tcurrentEl.childCurrentIndex++;\n\t\t\tstack.push( currentEl );\n\t\t\t\n\t\t\tcurrentEl = getEl( name );\n\t\t\tinElTag = true;\n\t\t},\n\t\tonattribute( name, value ) {\n\t\t\tcurrentEl.attributes[ currentAttr = name ] = value;\n\t\t},\n\t\tbindAttr( expr, binding ){\n\t\t\tconst name = binding.name = currentAttr;\n\t\t\t// specialized binding type\n\t\t\tconst parts = name.split( '-' );\n\t\t\tlet type = '';\n\t\t\tif( parts.length > 1 && ( type = specials[ parts[0] ] ) ) {\n\t\t\t\tdelete currentEl.attributes[ name ];\n\t\t\t}\n\t\t\tbinding.type = type || 'attr';\n\n\t\t\tthis.bind( expr, binding );\n\t\t},\n\t\tonopentag( name ) {\n\t\t\tconst el = currentEl;\n\t\t\tconst attrs = el.attributes;\n\t\t\tconst attrsText = Object.keys( el.attributes ).map( key => {\n\t\t\t\tconst val = attrs[key];\n\t\t\t\treturn val == null ? key : `${key}=\"${val}\"`;\n\t\t\t}).join(' ');\n\n\t\t\tel.htmlIndex = -2 + html.push(\n\t\t\t\t`<${name}${attrsText ? ' ' + attrsText : ''}`,\n\t\t\t\t'',\n\t\t\t\t`>`\n\t\t\t);\n\t\t\tdelete el.attributes;\n\t\t\tcurrentAttr = null;\n\t\t\tinElTag = false;\n\t\t},\n\t\tontext( text ) {\n\t\t\thtml.push( text );\n\t\t\tif( currentEl ) currentEl.childCurrentIndex++;\n\t\t},\n\t\tbind( expr, binding ){\n\t\t\tconst el = binding.el = currentEl;\n\t\t\tel.bound = true;\n\n\t\t\tif ( el === fragment ) {\n\t\t\t\tbinding.type = 'orphan-text';\n\t\t\t}\n\t\t\tif ( binding.index === -1 ) binding.index = el.childCurrentIndex;\n\t\t\t\n\t\t\tif ( expr.type === 'Identifier' ) binding.ref = expr.name\n\t\t\telse {\n\t\t\t\tbinding.expr = astring( expr );\n\t\t\t\tconst params = Array.from( undeclared( expr ).values() ).join();\n\t\t\t\tbinding.params = params;\n\t\t\t}\n\n\t\t\tel.bindings.push( binding );\n\t\t},\n\t\tunwrite( count = 1 ) {\n\t\t\tconst index = html.length - 1;\n\t\t\tconst current = html[ index ];\n\t\t\thtml[ index ] = current.slice( 0, -count );\n\t\t\tif ( !html[ index ] ) currentEl.childCurrentIndex--;\n\t\t},\n\t\tbindSection( expr ){\n\t\t\tconst el = currentEl;\n\t\t\tel.bound = true;\n\n\t\t\tel.bindings.push({  \n\t\t\t\tel, \n\t\t\t\ttype: 'section',\n\t\t\t\texpr: expr,\n\t\t\t\tindex: el.childCurrentIndex\n\t\t\t});\n\t\t},\n\t\tonclosetag( name ) {\n\t\t\thtml.push( `</${name}>` );\n\t\t\tconst el = currentEl;\n\t\t\tcurrentEl = stack.pop();\n\n\t\t\tif( el.bound ) {\n\t\t\t\thtml[ el.htmlIndex ] = ` data-bind`;\n\t\t\t\tcurrentEl.childBindings = currentEl.childBindings.concat( el.bindings );\n\t\t\t}\n\t\t\tif ( el.childBindings ) {\n\t\t\t\tcurrentEl.childBindings = currentEl.childBindings.concat( el.childBindings );\n\t\t\t}\n\t\t},\n\t\tonend() {\n\t\t\tif( fragment.childBindings.length ) {\n\t\t\t\tfragment.bindings = fragment.bindings.concat( fragment.childBindings );\n\t\t\t}\n\t\t}\n\t};\n\n\tvar parser = new htmlparser.Parser( handler );\n\n\tquasis.forEach( ( quasi, i ) => {\n\t\tconst raw =  quasi.value.raw;\n\t\tparser.write( raw );\n\t\t// TDOO extract to strategy for attr, text, etc. mov behavior in handler into those\n\t\tconst binding = {};\n\t\tconst observable = raw[ raw.length - 1 ] === '*';\n\t\tif ( observable ) {\n\t\t\thandler.unwrite(1);\n\t\t\tbinding.observable = observable;\n\t\t}\n\n\t\tif( currentAttr ) {\n\t\t\tif ( !attrPattern.test( raw ) ) throw 'unexpected ${...} in attributes';\n\t\t\t// finish the attr\n\t\t\tparser.write( '\"\"' );\n\t\t\tbinding.type = 'attr';\n\t\t\thandler.bindAttr( expressions[i], binding );\n\t\t}\n\t\telse if ( i < expressions.length && !inElTag ) {\n\t\t\t// if( raw[ raw.length - 1 ] === '#' ) {\n\t\t\t// \thandler.unwrite();\n\t\t\t// \tparser.write( '<section-node></section-node>' );\n\t\t\t// \thandler.bindSection( expressions[i] );\n\t\t\t// }\n\t\t\t// else {\n\t\t\t\tparser.write( '<text-node></text-node>' );\n\t\t\t\tbinding.type = 'child-text';\n\t\t\t\tbinding.index = -1 // auto-fill\n\t\t\t\thandler.bind( expressions[i], binding );\n\t\t\t//}\n\t\t}\n\t});\n\n\tparser.end();\n\n\tlet count = 0;\n\tconst map = new Map();\n\t\n\tconst orphans = [];\n\tfragment.bindings.forEach( b => {\n\t\tif ( b.el === fragment ) orphans.push( b );\n\t\telse {\n\t\t\tlet index;\n\t\t\tif ( map.has( b.el ) ) {\n\t\t\t\tindex = map.get( b.el );\t\n\t\t\t}\n\t\t\telse {\n\t\t\t\tindex = count++;\n\t\t\t\tmap.set( b.el, index );\n\t\t\t}\n\t\t\tb.elIndex = index;\n\t\t}\n\t\tdelete b.el;\n\t});\n\n\torphans.forEach( b => b.elIndex = map.size );\n\t\n\treturn { \n\t\thtml: html.join( '' ),\n\t\tbindings: fragment.bindings\n\t};\n}"],"names":[],"mappings":"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"}