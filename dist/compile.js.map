{"version":3,"file":"compile.js","sources":["../src/compile.js"],"sourcesContent":["import findImport from './findImport';\nimport findTemplates from './findTemplates';\nimport MagicString from 'magic-string';\nimport astring from 'astring';\nimport parse from './ast';\n\nexport default function compileAll( source ) {\n\tconst s = new MagicString( source );\n\tconst ast = parse( source );\n\n\tconst specifier = findImport( ast );\n\tconst tag = specifier ? specifier.local.name : '$';\n\tconst templates = findTemplates( ast, tag );\n\n\tconst codes = new Set();\n\tconst compile = compiler( s, codes );\n\ttemplates.map( compile );\n\n\tif ( specifier ) {\n\t\ts.overwrite( specifier.start, specifier.end, `renderer,makeFragment,${Array.from( codes.keys() ).map( c => `__${c}` ).join()}` );\n\t}\n\t\n\treturn s.toString();\n}\n\nconst bindingCode = {\n\t'orphan-text': 'tb',\n\t'child-text': 'tb'\n}\n\nfunction declareBinding( b, i ) {\n\treturn `\tconst __${bindingCode[b.type]}${i} = __${bindingCode[b.type]}(${b.index});`;\n}\nfunction bindObservable( b, i ) {\n\treturn `\t\tconst __s${i} = ${b.ref}.subscribe(__${bindingCode[b.type]}${i}(nodes[${b.elIndex}]));`\n}\n\nfunction bindStatic( b, i ) {\n\treturn `\t\t__${bindingCode[b.type]}${i}(nodes[${b.elIndex}])(${b.ref}.value);`\n}\n\nfunction unsubscribe( b, i, arr ) {\n\tif ( !b.observable ) return;\n\treturn `\t\t\t__s${i}.unsubscribe();${ i === arr.length - 1 ? '' : '\\n' }`;\n}\n\nfunction compiler( magicString, codes ) {\n\n\tconst s = magicString;\n\n\tfunction compile( { html, bindings, scope, node } ) {\n\t\tbindings.forEach( b => codes.add(bindingCode[b.type]) );\n\n\t\tlet code = \n`(() => {\n\tconst render = renderer(makeFragment(\\`${html}\\`));\n${bindings.map( declareBinding ).join('\\n')}\n\treturn (${scope.params.map(astring)}) => {\n\t\tconst nodes = render();\n${bindings.map( ( b, i ) => b.observable ? bindObservable( b, i ) : bindStatic( b, i ) ).join('\\n')}\n\t\tconst __fragment = nodes[nodes.length];\n\t\t__fragment.unsubscribe = () => {\n${bindings.map( unsubscribe ).join('')}\n\t\t};\n\t\treturn __fragment;\n\t};\n})()`;\n\n\t\ts.overwrite( scope.start, scope.end, code );\n\t}\n\n\treturn compile;\n}\n"],"names":[],"mappings":";;;;;kBAMwB;;AANxB;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEe,SAAS,UAAT,CAAqB,MAArB,EAA8B;AAC5C,OAAM,IAAI,0BAAiB,MAAjB,CAAV;AACA,OAAM,MAAM,mBAAO,MAAP,CAAZ;;AAEA,OAAM,YAAY,0BAAY,GAAZ,CAAlB;AACA,OAAM,MAAM,YAAY,UAAU,KAAV,CAAgB,IAA5B,GAAmC,GAA/C;AACA,OAAM,YAAY,6BAAe,GAAf,EAAoB,GAApB,CAAlB;;AAEA,OAAM,QAAQ,IAAI,GAAJ,EAAd;AACA,OAAM,UAAU,SAAU,CAAV,EAAa,KAAb,CAAhB;AACA,WAAU,GAAV,CAAe,OAAf;;AAEA,KAAK,SAAL,EAAiB;AAChB,IAAE,SAAF,CAAa,UAAU,KAAvB,EAA8B,UAAU,GAAxC,EAA8C,0BAAwB,MAAM,IAAN,CAAY,MAAM,IAAN,EAAZ,EAA2B,GAA3B,CAAgC,KAAM,MAAI,CAAE,GAA5C,EAAgD,IAAhD,EAAuD,GAA7H;AACA;;AAED,QAAO,EAAE,QAAF,EAAP;AACA;;AAED,MAAM,cAAc;AACnB,gBAAe,IADI;AAEnB,eAAc;AAFK,CAApB;;AAKA,SAAS,cAAT,CAAyB,CAAzB,EAA4B,CAA5B,EAAgC;AAC/B,QAAQ,aAAW,YAAY,EAAE,IAAd,CAAoB,KAAE,CAAE,UAAO,YAAY,EAAE,IAAd,CAAoB,MAAG,EAAE,KAAM,KAAjF;AACA;AACD,SAAS,cAAT,CAAyB,CAAzB,EAA4B,CAA5B,EAAgC;AAC/B,QAAQ,eAAa,CAAE,QAAK,EAAE,GAAI,kBAAe,YAAY,EAAE,IAAd,CAAoB,KAAE,CAAE,YAAS,EAAE,OAAQ,OAA5F;AACA;;AAED,SAAS,UAAT,CAAqB,CAArB,EAAwB,CAAxB,EAA4B;AAC3B,QAAQ,QAAM,YAAY,EAAE,IAAd,CAAoB,KAAE,CAAE,YAAS,EAAE,OAAQ,QAAK,EAAE,GAAI,WAApE;AACA;;AAED,SAAS,WAAT,CAAsB,CAAtB,EAAyB,CAAzB,EAA4B,GAA5B,EAAkC;AACjC,KAAK,CAAC,EAAE,UAAR,EAAqB;AACrB,QAAQ,UAAQ,CAAE,oBAAkB,MAAM,IAAI,MAAJ,GAAa,CAAnB,GAAuB,EAAvB,GAA4B,IAAM,GAAtE;AACA;;AAED,SAAS,QAAT,CAAmB,WAAnB,EAAgC,KAAhC,EAAwC;;AAEvC,OAAM,IAAI,WAAV;;AAEA,UAAS,OAAT,CAAkB,EAAE,IAAF,EAAQ,QAAR,EAAkB,KAAlB,EAAyB,IAAzB,EAAlB,EAAoD;AACnD,WAAS,OAAT,CAAkB,KAAK,MAAM,GAAN,CAAU,YAAY,EAAE,IAAd,CAAV,CAAvB;;AAEA,MAAI,OACL;0CAAA,CACyC,IAAK;EAAA,CAC7C,SAAS,GAAT,CAAc,cAAd,EAA+B,IAA/B,CAAoC,IAApC,CAA0C;WAAA,CACjC,MAAM,MAAN,CAAa,GAAb,mBAA0B;;EAAA,CAEnC,SAAS,GAAT,CAAc,CAAE,CAAF,EAAK,CAAL,KAAY,EAAE,UAAF,GAAe,eAAgB,CAAhB,EAAmB,CAAnB,CAAf,GAAwC,WAAY,CAAZ,EAAe,CAAf,CAAlE,EAAuF,IAAvF,CAA4F,IAA5F,CAAkG;;;EAAA,CAGlG,SAAS,GAAT,CAAc,WAAd,EAA4B,IAA5B,CAAiC,EAAjC,CAAqC;;;;KATrC;;AAeA,IAAE,SAAF,CAAa,MAAM,KAAnB,EAA0B,MAAM,GAAhC,EAAqC,IAArC;AACA;;AAED,QAAO,OAAP;AACA"}